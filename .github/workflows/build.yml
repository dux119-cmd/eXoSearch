name: Build Multi-Platform

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-windows:
    strategy:
      matrix:
        arch: [x86, x64, arm64]
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: ${{ matrix.arch }}
      
      - name: Configure CMake
        run: |
          cmake -B build -DCMAKE_BUILD_TYPE=Release `
            -DCMAKE_MSVC_RUNTIME_LIBRARY=MultiThreaded
      
      - name: Build
        run: cmake --build build --config Release
      
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: eds-windows-${{ matrix.arch }}
          path: build/Release/eds.exe

  build-macos:
    strategy:
      matrix:
        include:
          - arch: x64
            runner: macos-13
            cmake_arch: x86_64
          - arch: arm64
            runner: macos-14
            cmake_arch: arm64
    runs-on: ${{ matrix.runner }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Configure CMake
        run: |
          cmake -B build -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_OSX_ARCHITECTURES=${{ matrix.cmake_arch }} \
            -DCMAKE_EXE_LINKER_FLAGS="-static-libstdc++"
      
      - name: Build
        run: cmake --build build --config Release
      
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: eds-macos-${{ matrix.arch }}
          path: build/eds

  build-linux:
    strategy:
      matrix:
        include:
          - arch: x64
            runner: ubuntu-latest
            cmake_arch: x86_64
          - arch: arm64
            runner: ubuntu-latest
            cmake_arch: aarch64
    runs-on: ${{ matrix.runner }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Install dependencies (ARM64)
        if: matrix.arch == 'arm64'
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu
      
      - name: Configure CMake (x64)
        if: matrix.arch == 'x64'
        run: |
          cmake -B build -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_EXE_LINKER_FLAGS="-static-libgcc -static-libstdc++"
      
      - name: Configure CMake (ARM64)
        if: matrix.arch == 'arm64'
        run: |
          cmake -B build -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_SYSTEM_NAME=Linux \
            -DCMAKE_SYSTEM_PROCESSOR=aarch64 \
            -DCMAKE_C_COMPILER=aarch64-linux-gnu-gcc \
            -DCMAKE_CXX_COMPILER=aarch64-linux-gnu-g++ \
            -DCMAKE_EXE_LINKER_FLAGS="-static-libgcc -static-libstdc++"
      
      - name: Build
        run: cmake --build build --config Release
      
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: eds-linux-${{ matrix.arch }}
          path: build/eds

  create-release:
    needs: [build-windows, build-macos, build-linux]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: artifacts
      
      - name: Display structure
        run: ls -R artifacts
      
      - name: Create Release Archives
        run: |
          cd artifacts
          for dir in */; do
            zip -r "${dir%/}.zip" "$dir"
          done
      
      - name: Upload Release Assets
        uses: actions/upload-artifact@v4
        with:
          name: all-builds
          path: artifacts/*.zip
